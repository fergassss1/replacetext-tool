<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="images/favicon.png" type="image/x-icon">
  <title>beta/replacetext/tool</title>
  <!-- Load Roboto and Roboto Mono from Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Roboto+Mono:wght@400&display=swap" rel="stylesheet">
<style>
  :root {
    /* primary colors (shared) */
    --primary-blue: #007bff;
    --primary-blue-hover: #0056b3;

    /* light theme */
    --bg: #f5f5f5;
    --surface: #ffffff;
    --text: #111827;
    --muted: #6b7280;
    --border: #d1d5db;
  }

  /* dark theme overrides */
  .dark {
    --bg: #0b1020;
    --surface: #0f1724;
    --text: #e6eef8;
    --muted: #93a4c3;
    --border: #1f2937;
  }

  /* UI base */
  html, body {
    height: 100%;
  }

  body {
    font-family: 'Roboto', Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    padding: 20px;
    transition: background 160ms linear, color 160ms linear;
    box-sizing: border-box;
  }

  .top-row {
    display: flex;
    gap: 10px 16px;
    align-items: center;
    justify-content: space-between;
  }
  h2 {
    margin: 0;
    font-weight: 700;
  }

  .controls {
    display: flex;
    gap: 8px;
    align-items: center;
    width: 100%;
  }

/* Dark mode */
@media (prefers-color-scheme: dark) {
    .top-row {
        background-image: url('logo-dark.png');
        color: #fff; /* text color for dark mode */
    }
}
  

  /* shared control styles */
  textarea, .editable, button {
    width: 100%;
    margin-top: 10px;
    padding: 10px;
    font-size: 16px;
    box-sizing: border-box;
    border-radius: 12px;
    font-family: inherit; /* ensure all controls use Roboto */
  }

  .editable {
    min-height: 36px;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    overflow-y: auto;
    transition: background 160ms linear, border-color 160ms linear, color 160ms linear;
  }

  textarea {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    transition: background 160ms linear, border-color 160ms linear, color 160ms linear;
    resize: vertical;
  }
  textarea::placeholder {
    color: var(--muted); 
  }
  

  label {
    display: block;
    margin-top: 12px;
    color: var(--muted);
    font-size: 14px;
  }

  button.primary {
    cursor: pointer;
    background: var(--primary-blue);
    color: white;
    border: none;
    transition: background 0.3s;
  }

  button.primary:hover {
    background: var(--primary-blue-hover);
  }
.logo {
    width: 200px;
    height: 100px;
    background-image: url("images/betalogo-light.png");
    background-size: contain;
    background-repeat: no-repeat;
    background-position: left;
}

/* when dark mode is active */
.dark .logo {
    background-image: url("images/betalogo-dark.png");
}

  /* small secondary buttons (theme toggle etc) */
  .small-btn {
    padding: 8px 12px;
    border-radius: 10px;
    background: var(--surface);
    color: var(--text);
    border: 1px solid var(--border);
    cursor: pointer;
    transition: background 160ms linear, border-color 160ms linear, color 160ms linear;
    font-size: 14px;
  }

  .small-btn:hover {
    filter: brightness(0.95);
  }

  .blueData {
    color: var(--primary-blue);
    font-weight: normal;
    font-family: 'Roboto Mono', monospace; /* Roboto family monospace */
  }

  /* layout niceties */
  .actions {
    display: grid;
    gap: 8px;
    grid-auto-flow: column;
    align-items: center;
    width: 220px;
  }

  .footer-note {
    margin-top: 12px;
    color: var(--muted);
    font-size: 13px;
  }
</style>
</head>
<body>

  <div class="top-row">
    <div id="logo" class="logo"></div>
    <div class="actions">
      <button id="themeToggle" class="small-btn" aria-pressed="false" title="Toggle dark mode">toggle theme</button>
      <button id="replaceBtn" class="primary">replace!</button>
    </div>
  </div>

<label for="text">text:</label>
<textarea id="text" rows="6" placeholder="enter text here!"></textarea>

<label>find:</label>
<div id="find" class="editable" contenteditable="true" aria-label="Find pattern"></div>

<label>replace with:</label>
<div id="replace" class="editable" contenteditable="true" aria-label="Replace pattern"></div>

<div style="display:none" id="sr">screenreader helper</div>

<div class="footer-note">
  ! use <span class="blueData">$data</span> inside find and replace with if you want to keep data on another type of brackets! (or get rid of it)
  <br><br>
  <a href="index" class="small-btn">exit beta</a>
  </div>
  
</div>

<script>
  // Theme toggle + persistence
  (function() {
    const html = document.documentElement;
    const toggle = document.getElementById('themeToggle');
    const saved = localStorage.getItem('theme');

    function applyTheme(mode) {
      if (mode === 'dark') {
        html.classList.add('dark');
        toggle.textContent = 'dark mode';
        toggle.setAttribute('aria-pressed', 'true');
      } else {
        html.classList.remove('dark');
        toggle.textContent = 'light mode';
        toggle.setAttribute('aria-pressed', 'false');
      }
    }

    if (saved === 'dark' || (!saved && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      applyTheme('dark');
    } else {
      applyTheme('light');
    }

    toggle.addEventListener('click', () => {
      const isDark = html.classList.contains('dark');
      const next = isDark ? 'light' : 'dark';
      applyTheme(next);
      localStorage.setItem('theme', next);
    });
  })();

  // Replace button
  document.getElementById('replaceBtn').addEventListener('click', replaceText);
function getCaretCharacterOffsetWithin(element) {
  const selection = window.getSelection();
  if (!selection.rangeCount) return 0;

  const range = selection.getRangeAt(0);
  const preRange = range.cloneRange();
  preRange.selectNodeContents(element);
  preRange.setEnd(range.endContainer, range.endOffset);

  return preRange.toString().length;
}

function setCaretPosition(element, offset) {
  const range = document.createRange();
  const selection = window.getSelection();

  let currentOffset = 0;
  let nodeStack = [element];
  let node;

  while ((node = nodeStack.pop())) {
    if (node.nodeType === Node.TEXT_NODE) {
      const nextOffset = currentOffset + node.length;
      if (offset <= nextOffset) {
        range.setStart(node, offset - currentOffset);
        range.collapse(true);
        selection.removeAllRanges();
        selection.addRange(range);
        return;
      }
      currentOffset = nextOffset;
    } else {
      let i = node.childNodes.length;
      while (i--) nodeStack.push(node.childNodes[i]);
    }
  }
  // Highlight $data inside contenteditable
  function colorData(div) {
  const caretOffset = getCaretCharacterOffsetWithin(div);

  const text = div.textContent;
  div.innerHTML = text.replace(
    /\$data/g,
    '<span class="blueData">$data</span>'
  );

  setCaretPosition(div, caretOffset);
}
  }

  document.getElementById("find").addEventListener("input", function() {
    colorData(this);
  });
  document.getElementById("replace").addEventListener("input", function() {
    colorData(this);
  });

  function escapeForRegExp(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  function replaceText() {
  const textArea = document.getElementById("text");
  
  // 1. SAVE the current cursor position
  const selectionStart = textArea.selectionStart;
  const selectionEnd = textArea.selectionEnd;

  let findValue = document.getElementById("find").textContent;
  let replaceValue = document.getElementById("replace").textContent;

  if (!findValue) return;

  // ... [Your existing logic for regex and replacement] ...
  if (findValue.includes("$data") && replaceValue.includes("$data")) {
    const parts = findValue.split(/\$data/g).map(part => escapeForRegExp(part));
    const regex = new RegExp(parts.join("([\\s\\S]+?)"), "g");

    textArea.value = textArea.value.replace(regex, (...args) => {
      const captured = args.slice(1, args.length - 2 + 1);
      let result = replaceValue;
      let index = 0;
      result = result.replace(/\$data/g, () => captured[index++] ?? '');
      return result;
    });
  } else {
    const regex = new RegExp(escapeForRegExp(findValue), "g");
    textArea.value = textArea.value.replace(regex, replaceValue);
  }

  // 2. RESTORE the cursor position
  // We use the saved position so the browser doesn't reset to 0
  textArea.setSelectionRange(selectionStart, selectionEnd);
}


  // Initialize $data highlighting for prefilled content
  document.querySelectorAll('.editable').forEach(div => colorData(div));
</script>
</body>
  </html>
